<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Shopping Cart</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body { background-color: #f8f9fa; }
        .cart-item-card { transition: box-shadow 0.3s ease; }
        .cart-item-card:hover { box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1); }
        .quantity-input { width: 60px !important; } /* Fixed width for better UI */
    </style>
</head>
<body>

    <nav class="navbar navbar-light bg-white shadow-sm">
        <div class="container-fluid container-lg">
            <a class="navbar-brand fw-bold text-primary" href="index.html">‚Üê Back to Shopping</a>
            <span class="navbar-text fw-bold h4 m-0"><i class="fas fa-shopping-cart me-2"></i>Your Cart</span>
        </div>
    </nav>
    
    <div class="container-lg py-5">
        <h2 class="fw-bold mb-4">Your Shopping Cart</h2>
        
        <div class="row">
            <div class="col-lg-8">
                <div id="cart-container">
                    <div class="text-center text-secondary py-5">
                        <i class="fas fa-spinner fa-spin me-2"></i> Loading your cart...
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card shadow-sm sticky-top" style="top: 20px;">
                    <div class="card-body">
                        <h4 class="card-title fw-bold mb-3">Order Summary</h4>
                        <ul class="list-group list-group-flush mb-3">
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Total Items:</span>
                                <span id="summary-total-items" class="fw-semibold">0</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Subtotal:</span>
                                <span id="summary-subtotal" class="fw-semibold">$0.00</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between fw-bold bg-light">
                                <span>Grand Total:</span>
                                <span id="summary-grand-total">$0.00</span>
                            </li>
                        </ul>
                        <button class="btn btn-success w-100 fw-bold rounded-pill py-2" id="checkout-btn" disabled>Proceed to Checkout</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="liveToast" class="toast align-items-center text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="toast-message"></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>

    <script defer>
        const BACKEND_URL = 'http://localhost:8092/api';
        let currentCartItems = []; 
        // cart.html ke <script> tag mein yeh function add ya update karein
document.getElementById('checkout-btn').onclick = function() {
    const totalAmount = document.getElementById('summary-grand-total').textContent.replace('$', '');
    
    // Total Amount ko local storage mein save karna
    localStorage.setItem('cartGrandTotal', totalAmount);
    
    // Order page par redirect karna
    window.location.href = 'order.html'; 
};

        // --- Utility Functions (Toast & User ID) ---
        function showToast(message, type = 'info') {
            const toastElement = document.getElementById('liveToast');
            const toastBody = document.getElementById('toast-message');
            toastBody.textContent = message;
            
            toastElement.className = 'toast align-items-center text-white border-0';
            if (type === 'success') {
                toastElement.classList.add('bg-success');
            } else if (type === 'error') {
                toastElement.classList.add('bg-danger');
            } else {
                toastElement.classList.add('bg-primary');
            }

            const toastBootstrap = new bootstrap.Toast(toastElement, { delay: 3000 });
            toastBootstrap.show();
        }

        

        function getUserId() {
            const userId = localStorage.getItem('userId');
            if (!userId) {
                showToast('Please log in to view your cart.', 'error');
                setTimeout(() => window.location.href = 'index.html', 1000); 
                return null;
            }
            return parseInt(userId);
        }

        // --- API Call: Fetch Cart Details (Updated to be more robust) ---
        async function fetchCartDetails() {
            const userId = getUserId();
            if (!userId) return;

            const container = document.getElementById('cart-container');
            container.innerHTML = `<div class="text-center text-secondary py-5"><i class="fas fa-spinner fa-spin me-2"></i> Fetching cart details...</div>`;
            
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${BACKEND_URL}/get-cart-details/${userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to fetch cart. Status: ${response.status}. Details: ${errorText.substring(0, 100)}`);
                }

                const result = await response.json();
                
                // Since the backend now correctly returns List<CartResponse> directly:
                let cartItems = Array.isArray(result) ? result : null;
                
                if (Array.isArray(cartItems)) {
                    currentCartItems = cartItems; 
                    renderCart(currentCartItems);
                } else {
                    console.error("API returned non-array data structure (Expected List<CartResponse>):", result);
                    renderCart([]); // Show empty cart message
                }

            } catch (error) {
                console.error('API Error fetching cart:', error);
                container.innerHTML = `<div class="text-center text-danger fw-semibold py-5">
                    <i class="fas fa-exclamation-triangle me-2"></i> Network Error or unexpected data format. Please check console.
                </div>`;
                showToast('Failed to load cart. Server error or unexpected data format.', 'error');
            }
        }
        
        // üöÄ CRITICAL FUNCTION: Update Quantity via Backend API
        window.updateQuantityApi = async function(cartId, newQuantityStr, inputElement) {
            let newQuantity = parseInt(newQuantityStr);
            
            const itemToUpdate = currentCartItems.find(item => item.cartId === cartId);
            const oldQuantity = itemToUpdate ? itemToUpdate.quantity : 1;

            if (isNaN(newQuantity) || newQuantity < 1) {
                showToast('Quantity must be 1 or greater.', 'error');
                inputElement.value = oldQuantity; // Revert locally
                return;
            }

            // Quick local update for responsive UI
            if(itemToUpdate) itemToUpdate.quantity = newQuantity;
            renderCart(currentCartItems);
            showToast(`Updating item quantity to ${newQuantity}...`, 'info');
            
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${BACKEND_URL}/update-cart-quantity/${cartId}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({ quantity: newQuantity }) 
                });

                if (response.ok) {
                    showToast(`Quantity updated successfully.`, 'success');
                    // Fetch the cart to get the latest Total Price calculated by the backend
                    await fetchCartDetails(); 
                } else {
                    const errorResult = await response.json().catch(() => ({ message: "Server response error." }));
                    const errorMessage = errorResult.error || errorResult.message || "Failed to update quantity.";
                    showToast(errorMessage, 'error');
                    // Revert UI to match DB state if update fails
                    await fetchCartDetails(); 
                }
            } catch (error) {
                console.error('Update Cart API Error:', error);
                showToast('Network error during quantity update. Please check server.', 'error');
                await fetchCartDetails(); 
            }
        }

        // --- Rendering Logic (Synchronized with Backend DTO) ---
        function renderCart(cartItems) {
            const container = document.getElementById('cart-container');
            const summaryTotalItems = document.getElementById('summary-total-items');
            const summarySubtotal = document.getElementById('summary-subtotal');
            const summaryGrandTotal = document.getElementById('summary-grand-total');

            if (cartItems.length === 0) {
                container.innerHTML = `<div class="alert alert-info text-center py-5">
                    <i class="fas fa-box-open me-2"></i> Your cart is empty.
                </div>`;
                summaryTotalItems.textContent = '0';
                summarySubtotal.textContent = '$0.00';
                summaryGrandTotal.textContent = '$0.00';
                document.getElementById('checkout-btn').disabled = true;
                return;
            }

            let totalItems = 0;
            let subtotal = 0;
            
            const cartHtml = cartItems.map(item => {
                // item.price is the UNIT PRICE (from CartResponse DTO)
                const unitPrice = parseFloat(item.price) || 0; 
                const quantity = parseInt(item.quantity) || 0;
                
                // item.itemPriceTotal is the LINE ITEM TOTAL (from CartResponse DTO)
                const itemTotal = parseFloat(item.itemPriceTotal) || (unitPrice * quantity); 

                totalItems += quantity;
                subtotal += itemTotal;
                
                // Placeholder image generation (using item.productId for consistency)
                const hash = (item.productId || 1).toString(16).padStart(6, '0').slice(0, 6);
                const imageUrl = `https://placehold.co/100x100/${hash}/ffffff?text=${encodeURIComponent(item.productName || 'Product')}`;

                return `
                    <div class="card mb-3 cart-item-card border-0 shadow-sm" id="cart-item-${item.cartId}">
                        <div class="row g-0">
                            <div class="col-md-2 col-3">
                                <img src="${imageUrl}" class="img-fluid rounded-start p-2" alt="${item.productName}" style="height: 100%; object-fit: cover;">
                            </div>
                            <div class="col-md-10 col-9">
                                <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center py-3">
                                    <div class="flex-grow-1 mb-2 mb-md-0">
                                        <h5 class="card-title fw-bold mb-1">${item.productName}</h5>
                                        <p class="mb-0 text-muted small">Unit Price: $${unitPrice.toFixed(2)}</p>
                                    </div>
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="input-group input-group-sm" style="width: 120px;">
                                            <span class="input-group-text">Qty</span>
                                            <input 
                                                type="number" 
                                                class="form-control text-center fw-semibold quantity-input" 
                                                value="${quantity}" 
                                                min="1" 
                                                data-cart-id="${item.cartId}"
                                                onchange="updateQuantityApi(${item.cartId}, this.value, this)" 
                                            >
                                        </div>
                                        <span class="fw-bolder text-primary fs-5 me-3" id="item-total-${item.cartId}">$${itemTotal.toFixed(2)}</span>
                                        <button 
                                            class="btn btn-outline-danger btn-sm rounded-circle"
                                            title="Remove Item"
                                            onclick="removeCartItemApi(${item.cartId})"
                                        >
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Update Summary
            const grandTotal = subtotal; 
            summaryTotalItems.textContent = totalItems;
            summarySubtotal.textContent = `$${subtotal.toFixed(2)}`;
            summaryGrandTotal.textContent = `$${grandTotal.toFixed(2)}`;
            document.getElementById('checkout-btn').disabled = false;
            
            container.innerHTML = cartHtml;
        }

        // --- API Call: Remove Item from Cart ---
        window.removeCartItemApi = async function(cartId) {
            if (!confirm('Are you sure you want to remove this item from the cart?')) {
                return;
            }

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${BACKEND_URL}/delete-cart-byId/${cartId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json().catch(() => ({ message: "Item removed, but server did not return JSON." }));

                if (response.ok) {
                    showToast(`Item removed from cart.`, 'success');
                    // Refresh the cart to update totals
                    fetchCartDetails(); 
                } else {
                    const errorMessage = result.error || result.message || "Failed to remove item.";
                    showToast(errorMessage, 'error');
                }

            } catch (error) {
                console.error('Remove from Cart API Error:', error);
                showToast('Network error. Could not connect to the server.', 'error');
            }
        }
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', fetchCartDetails);

    </script>
</body>
</html>