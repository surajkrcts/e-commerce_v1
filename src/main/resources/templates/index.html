<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Commerce Project - Bootstrap Dynamic</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        .navbar-brand {
            font-weight: 800;
            letter-spacing: -0.5px;
            color: #4f46e5 !important;
        }
        .hero-section {
            background-color: #f0f4ff; 
            color: #1f2937; 
            padding-top: 6rem; 
            padding-bottom: 6rem; 
        }
        .hero-title {
            font-size: clamp(2.5rem, 6vw, 4rem); 
            font-weight: 800; 
            line-height: 1.1;
        }
        
        .category-item {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }
        .category-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 1rem 3rem rgba(0, 0, 0, 0.175) !important;
        }
        
        .truncate {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        
        .horizontal-scroll-container {
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 1rem;
            margin-bottom: -1rem;
        }

        .horizontal-scroll-container::-webkit-scrollbar {
            display: none;
        }
        .horizontal-scroll-container {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top" id="main-navbar">
    <div class="container-fluid container-lg">
        <a class="navbar-brand" href="#">E-Com</a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="#">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#categories-section">Category</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#products-section">Products</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="cart.html">Cart</a>
                </li>
            </ul>

            <div class="d-flex align-items-center" id="auth-controls">
            </div>
        </div>
    </div>
</nav>

<div id="app-container">
    <div class="hero-section px-3">
        <div class="container-lg">
            <div class="row justify-content-center">
                <div class="col-12 col-lg-10 mb-5 mb-lg-0 text-center">
                        <span class="badge bg-primary-subtle text-primary fw-semibold mb-3 py-2 px-3 rounded-pill">
                            New Arrivals 2025
                        </span>
                    <h2 class="hero-title">
                        Discover <span class="text-primary">Innovation</span>, Delivered Fast.
                    </h2>
                    <p class="lead mt-3 text-secondary mx-auto" style="max-width: 700px;">
                        Explore the latest trends in technology and home essentials with lightning-fast shipping and guaranteed quality.
                    </p>
                    <div class="mt-5 d-flex flex-column flex-sm-row gap-3 justify-content-center">
                        <a
                                href="#products-section"
                                class="btn btn-primary btn-lg rounded-pill fw-bold px-5 py-3 shadow-lg"
                        >
                            Shop Now
                        </a>
                        <a
                                href="#categories-section"
                                class="btn btn-outline-dark btn-lg rounded-pill fw-bold px-5 py-3"
                        >
                            Browse Categories
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="categories-section" class="py-5 bg-light px-3">
        <div class="container-lg">
            <h2 class="text-3xl fw-bold text-dark text-center mb-5">Shop By Category</h2>
            <div class="horizontal-scroll-container d-flex flex-nowrap" id="categories-container">
                <div class="p-2 text-center text-secondary" style="flex: 0 0 100%;">
                    <i class="fas fa-spinner fa-spin me-2"></i> Loading categories...
                </div>
            </div>
        </div>
    </div>

    <div id="products-section" class="py-5 px-3">
        <div class="container-lg">
            <h2 class="text-3xl fw-bold text-dark text-center mb-5">Featured Products</h2>
            <div class="horizontal-scroll-container d-flex flex-nowrap" id="products-container">
                <div class="p-2 text-center text-secondary" style="flex: 0 0 100%;">
                    <i class="fas fa-spinner fa-spin me-2"></i> Loading products...
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white py-5 px-3">
        <div class="container-lg">
            <div class="row">
                <div class="col-6 col-md-3 mb-3">
                    <h3 class="h5 fw-bold mb-3">E-Com Project</h3>
                    <p class="text-sm text-gray-400">Shop Smarter. Live Better.</p>
                </div>
                <div class="col-6 col-md-3 mb-3">
                    <h4 class="h6 fw-semibold mb-3">Company</h4>
                    <ul class="list-unstyled space-y-2 text-sm text-gray-400">
                        <li>About Us</li>
                        <li>Careers</li>
                        <li>Privacy Policy</li>
                        <li>Terms & Conditions</li>
                    </ul>
                </div>
                <div class="col-6 col-md-3 mb-3">
                    <h4 class="h6 fw-semibold mb-3">Support</h4>
                    <ul class="list-unstyled space-y-2 text-sm text-gray-400">
                        <li>Help Center</li>
                        <li>Shipping</li>
                        <li>Returns</li>
                        <li>FAQ</li>
                    </ul>
                </div>
                <div class="col-6 col-md-3 mb-3">
                    <h4 class="h6 fw-semibold mb-3">Connect</h4>
                    <p class="text-sm text-gray-400">123 Main St, New York, NY</p>
                    <p class="text-sm text-gray-400">contact@ecom.com</p>
                </div>
            </div>
            <div class="mt-4 pt-3 border-top border-secondary text-center text-sm text-gray-400">
                &copy; 2025 E-Com. All rights reserved.
            </div>
        </div>
    </footer>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="liveToast" class="toast align-items-center text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="toast-message"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<div class="modal fade" id="productDetailModal" tabindex="-1" aria-labelledby="productDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-xl shadow-lg border-0">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold" id="productDetailModalLabel">Product Name Placeholder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row">
                    <div class="col-md-5 mb-3 mb-md-0">
                        <img id="modal-image" src="https://placehold.co/600x400/CCCCCC/333333?text=Product+Image" alt="Product Image" class="img-fluid rounded-lg shadow-sm" style="max-height: 300px; width: 100%; object-fit: cover;">
                    </div>
                    <div class="col-md-7">
                        <p class="text-muted small mb-2">Category: <span id="modal-category" class="fw-semibold text-primary"></span></p>
                        <h4 id="modal-price" class="fw-bolder text-dark mb-3">$0.00</h4>
                        <hr class="my-3">
                        <p class="fw-semibold text-dark mb-2">Description:</p>
                        <p id="modal-description" class="text-secondary small"></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light border-0">
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="loginModalLabel">Login Required</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-5">
                <p>You need to log in to access this feature.</p>
                <a href="login.html" class="btn btn-primary rounded-pill d-inline-flex align-items-center fw-bold px-4 py-2">
                    <i class="fas fa-sign-in-alt me-2"></i> Go to Login Page
                </a>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>

<script defer>
    let allProducts = [];
    // **IMPORTANT:** Update this URL to your actual backend API base URL
    const BACKEND_URL = 'http://localhost:8092/api';

    /**
     * Shows a Bootstrap Toast notification.
     * @param {string} message The message to display.
     * @param {('success'|'error'|'info')} type The type of toast.
     */
    function showToast(message, type = 'info') {
        const toastElement = document.getElementById('liveToast');
        const toastBody = document.getElementById('toast-message');

        toastBody.textContent = message;

        // Reset and set class based on type
        toastElement.className = 'toast align-items-center text-white border-0';
        if (type === 'success') {
            toastElement.classList.add('bg-success');
        } else if (type === 'error') {
            toastElement.classList.add('bg-danger');
        } else {
            toastElement.classList.add('bg-primary');
        }

        const toastBootstrap = new bootstrap.Toast(toastElement, { delay: 3000 });
        toastBootstrap.show();
    }

    /**
     * Gets User ID from localStorage and shows login modal if not present.
     * @returns {number|null} The user ID or null if not logged in.
     */
    function getUserId() {
        const userId = localStorage.getItem('userId');
        if (!userId) {
            showToast('Please log in to add items to your cart.', 'error');
            // The Login Modal will handle the redirect based on the HTML structure
            const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
            loginModal.show();
            return null;
        }
        return parseInt(userId);
    }

    /**
     * Calls the API to add a product to the user's cart.
     * @param {number} productId The ID of the product to add.
     * @param {number} quantity The quantity to add (default 1).
     */
    async function addToCartApi(productId, quantity = 1) {
        const userId = getUserId();
        const token = localStorage.getItem('authToken');

        if (!userId || !token) {
            return; // getUserId handles the login prompt
        }

        // Close the product detail modal upon adding to cart
        const modalInstance = bootstrap.Modal.getInstance(document.getElementById('productDetailModal'));
        if(modalInstance) modalInstance.hide();


        try {
            const cartRequest = {
                userId: userId,
                productId: productId,
                quantity: quantity
            };

            const response = await fetch(`${BACKEND_URL}/add-product-to-cart`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(cartRequest)
            });

            const result = await response.json();

            if (response.ok) {
                const productName = result.data?.productName || result.productName || 'Item';
                const addedQuantity = result.data?.quantity || result.quantity || quantity;
                showToast(`"${productName}" added to cart! (Qty: ${addedQuantity})`, 'success');
            } else {
                const errorMessage = result.error || result.message || "Failed to add product to cart.";
                showToast(errorMessage, 'error');
            }

        } catch (error) {
            console.error('Add to Cart API Error:', error);
            showToast('Network error. Could not connect to the server.', 'error');
        }
    }

    /**
     * Clears user local storage data and redirects to login.
     */
    window.logoutUser = function() {
        localStorage.removeItem('authToken');
        localStorage.removeItem('username');
        localStorage.removeItem('userId');
        showToast('You have been logged out successfully.', 'success');

        updateAuthUI();

        // Redirect to login page after a short delay
        setTimeout(() => {
            window.location.href = 'login.html';
        }, 500);
    }

    /**
     * Updates the navigation bar's authentication controls (Login/Welcome user).
     * FIX: Now includes the edit icon and link to update.html.
     */
    function updateAuthUI() {
        const authControls = document.getElementById('auth-controls');
        const token = localStorage.getItem('authToken');
        const username = localStorage.getItem('username');

        if (token && username) {
            authControls.innerHTML = `
                <span class="navbar-text me-3 fw-semibold text-dark d-flex align-items-center">
                    Welcome,
                    <a href="update.html" class="text-primary text-decoration-none mx-1" title="Update Profile">
                        <span class="text-primary">${username}</span>
                        <i class="fas fa-edit small ms-1"></i>
                    </a>!
                </span>
                <button class="btn btn-outline-danger rounded-pill d-flex align-items-center" onclick="logoutUser()">
                    <i class="fas fa-sign-out-alt me-2"></i>Logout
                </button>
            `;
        } else {
            authControls.innerHTML = `
                <button class="btn btn-primary rounded-pill d-flex align-items-center" data-bs-toggle="modal" data-bs-target="#loginModal">
                    <i class="fas fa-sign-in-alt me-2"></i>Login
                </button>
            `;
        }
    }

    /**
     * Fetches all categories from the API.
     */
    async function fetchCategories() {
        const container = document.getElementById('categories-container');
        container.innerHTML = `<div class="p-2 text-center text-secondary" style="flex: 0 0 100%;"><i class="fas fa-spinner fa-spin me-2"></i> Loading categories...</div>`;

        try {
            const response = await fetch(`${BACKEND_URL}/get-all-category`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            // Assuming the response is an array of category objects
            const categories = await response.json();
            renderCategorySection(categories);

        } catch (error) {
            console.error('API Error fetching categories:', error);
            container.innerHTML = `<div class="p-2 text-center text-danger fw-semibold" style="flex: 0 0 100%;">Error loading categories. Check your backend connection.</div>`;
        }
    }

    /**
     * Fetches all products from the API.
     */
    async function fetchProducts() {
        const container = document.getElementById('products-container');
        container.innerHTML = `<div class="p-2 text-center text-secondary" style="flex: 0 0 100%;"><i class="fas fa-spinner fa-spin me-2"></i> Loading products...</div>`;

        try {
            const response = await fetch(`${BACKEND_URL}/getall`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const result = await response.json();
            // Handle cases where product list might be nested (e.g., in a 'product' field)
            const products = result.product || result;

            if (!Array.isArray(products)) throw new Error('Invalid product data format.');

            // Enhance product data (like adding a placeholder image URL for display)
            const combinedProducts = products.map((prod, index) => {
                // Generate a unique color hash for placeholder image
                const uniqueId = prod.productId || index * 1000;
                const hash = uniqueId.toString(16).padStart(6, '0').slice(0, 6);
                const categoryName = prod.category?.categoryName || prod.categoryName || 'N/A';

                return {
                    ...prod,
                    // Using a dynamic placeholder image URL
                    image: `https://placehold.co/600x400/${hash}/ffffff?text=${encodeURIComponent(prod.name || 'Product')}`,
                    categoryName: categoryName
                }
            });

            allProducts = combinedProducts;
            renderProductFeatureSection(combinedProducts);

        } catch (error) {
            console.error('API Error fetching products:', error);
            container.innerHTML = `<div class="p-2 text-center text-danger fw-semibold" style="flex: 0 0 100%;">Error loading products. Check your backend connection.</div>`;
        }
    }

    /**
     * Displays the product details modal for a given product ID.
     * This function is made globally available via 'window' for use in inline onclick handlers.
     * @param {number|string} productId The ID of the product.
     */
    window.showProductDetails = function(productId) {
        const product = allProducts.find(p => String(p.productId) === String(productId));
        if (!product) {
            showToast('Product details not found. Please refresh the page.', 'error');
            return;
        }

        const modalTitle = document.getElementById('productDetailModalLabel');
        const modalImage = document.getElementById('modal-image');
        const modalPrice = document.getElementById('modal-price');
        const modalCategory = document.getElementById('modal-category');
        const modalDescription = document.getElementById('modal-description');
        const modalElement = document.getElementById('productDetailModal');

        modalTitle.textContent = product.name || 'Product Details';
        modalImage.src = product.image;
        modalPrice.textContent = `$${(product.price || 0.00).toFixed(2)}`;
        modalCategory.textContent = product.categoryName || 'N/A';
        modalDescription.textContent = product.description || 'No description available for this product.';

        const modalFooter = document.querySelector('#productDetailModal .modal-footer');

        // Dynamically set the Add to Cart button with the product ID
        modalFooter.innerHTML = `
            <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-success rounded-pill" onclick="addToCartApi(${product.productId})">
                <i class="fas fa-cart-plus me-2"></i> Add to Cart
            </button>
        `;

        const modalInstance = new bootstrap.Modal(modalElement);
        modalInstance.show();
    }

    /**
     * Renders the category cards.
     * @param {Array<Object>} categories Array of category objects.
     */
    function renderCategorySection(categories) {
        const container = document.getElementById('categories-container');
        if (categories.length === 0) {
            container.innerHTML = `<div class="p-2 text-center text-secondary" style="flex: 0 0 100%;">No categories found in the database.</div>`;
            return;
        }
        const categoryCards = categories.map((cat) => {
            const icon = '📦'; // Default icon
            // Add more specific icons if needed here based on category name
            return `
                <div class="p-2" style="flex: 0 0 25%; max-width: 25%; min-width: 150px;">
                    <div class="category-item bg-white p-4 rounded-xl shadow-lg border border-light text-center h-100">
                        <div class="display-4 mb-2">${icon}</div>
                        <h3 class="h6 fw-semibold text-dark">${cat.categoryName}</h3>
                    </div>
                </div>
            `;
        }).join('');
        container.innerHTML = categoryCards;
    }

    /**
     * Renders the product cards for the featured products section.
     * @param {Array<Object>} products Array of product objects.
     */
    function renderProductFeatureSection(products) {
        const container = document.getElementById('products-container');
        if (products.length === 0) {
            container.innerHTML = `<div class="p-2 text-center text-secondary" style="flex: 0 0 100%;">No products found in the database.</div>`;
            return;
        }
        const productCards = products.map(product => `
            <div class="p-2" style="flex: 0 0 25%; max-width: 25%; min-width: 250px;">
                <div class="card shadow-lg rounded-xl overflow-hidden h-100 border-0">
                    <img
                        src="${product.image}"
                        alt="${product.name}"
                        class="card-img-top"
                        style="height: 200px; object-fit: cover;"
                        onerror="this.onerror=null; this.src='https://placehold.co/600x400/CCCCCC/333333?text=Image+Missing';"
                    />
                    <div class="card-body p-4 d-flex flex-column">
                        <h3 class="h5 fw-bold text-dark truncate" title="${product.name}">${product.name}</h3>
                        <p class="mt-1 fs-4 fw-bolder text-primary">$${(product.price || 0.00).toFixed(2)}</p>
                        <button
                            class="btn btn-primary mt-auto w-100 rounded-lg fw-semibold shadow-md"
                            onclick="showProductDetails('${product.productId}')"
                        >
                            View Details
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
        container.innerHTML = productCards;
    }

    /**
     * Initializes the page by loading UI and fetching data.
     */
    document.addEventListener('DOMContentLoaded', () => {
        updateAuthUI(); // Check login status and update navbar
        fetchCategories(); // Load categories
        fetchProducts(); // Load products
    });
</script>
</body>
</html>