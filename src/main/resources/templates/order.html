<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body { background-color: #f8f9fa; }
        .order-status { font-weight: bold; }
        .PENDING { color: #ffc107; } /* Amber */
        .SHIPPED { color: #0dcaf0; } /* Info/Cyan */
        .DELIVERED { color: #198754; } /* Success/Green */
        .CANCELLED { color: #dc3545; } /* Danger/Red */
    </style>
</head>
<body>

    <nav class="navbar navbar-light bg-white shadow-sm">
        <div class="container-fluid container-lg">
            <a class="navbar-brand fw-bold text-primary" href="index.html">‚Üê Back to Shopping</a>
            <span class="navbar-text fw-bold h4 m-0"><i class="fas fa-receipt me-2"></i>My Orders</span>
        </div>
    </nav>
    
    <div class="container-lg py-5">
        <h2 class="fw-bold mb-4">Order Management</h2>
        
        <div class="row mb-5">
            <div class="col-md-6 offset-md-3">
                <div class="input-group shadow-sm">
                    <input type="number" class="form-control" placeholder="Search Order ID" id="search-order-id" aria-label="Order ID">
                    <button class="btn btn-primary" type="button" onclick="searchOrder()">
                        <i class="fas fa-search me-1"></i> Search Order
                    </button>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-white fw-bold">
                        Order Details
                    </div>
                    <div class="card-body" id="order-details-container">
                        <p class="text-center text-muted m-0">
                            Search for an Order ID above or proceed from your cart.
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="liveToast" class="toast align-items-center text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="toast-message"></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>

   <script defer>
    const BACKEND_URL = 'http://localhost:8092';
    
    // --- Utility Functions (Toast & User ID) ---
    function showToast(message, type = 'info') {
        const toastElement = document.getElementById('liveToast');
        const toastBody = document.getElementById('toast-message');
        toastBody.textContent = message;
        
        toastElement.className = 'toast align-items-center text-white border-0';
        if (type === 'success') {
            toastElement.classList.add('bg-success');
        } else if (type === 'error') {
            toastElement.classList.add('bg-danger');
        } else {
            toastElement.classList.add('bg-primary');
        }

        const toastBootstrap = new bootstrap.Toast(toastElement, { delay: 3000 });
        toastBootstrap.show();
    }

    function getUserId() {
        const userId = localStorage.getItem('userId');
        if (!userId) {
            showToast('Please log in to manage your orders.', 'error');
            // window.location.href = 'login.html'; 
            return null; 
        }
        return parseInt(userId);
    }

    // --- 1. Order Creation Logic ---
    async function createOrderFromCart() {
        const userId = getUserId();
        if (!userId) return;

        const urlParams = new URLSearchParams(window.location.search);
        const existingOrderId = urlParams.get('orderId');
        if (existingOrderId) {
            searchOrder(existingOrderId);
            return;
        }

        const totalAmountStr = localStorage.getItem('cartGrandTotal');
        const totalAmount = parseFloat(totalAmountStr);

        if (isNaN(totalAmount) || totalAmount <= 0) {
             document.getElementById('order-details-container').innerHTML = `<div class="alert alert-warning">No cart items found. Please search an Order ID.</div>`;
             return;
        }

        showToast('Creating your order...', 'info');

        try {
            const token = localStorage.getItem('authToken');
            const response = await fetch(`${BACKEND_URL}/create-order`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` 
                },
                body: JSON.stringify({ 
                    userId: userId, 
                    totalAmount: totalAmount 
                }) 
            });

            const result = await response.json();

            if (response.ok) {
                showToast(`Order created successfully! ID: ${result.orderId}`, 'success');
                localStorage.removeItem('cartGrandTotal'); 
                renderOrderDetails(result);

                const newUrl = new URL(window.location.href);
                newUrl.searchParams.set('orderId', result.orderId);
                window.history.pushState({ orderId: result.orderId }, '', newUrl);

            } else {
                const errorMessage = result.error || "Order creation failed.";
                showToast(errorMessage, 'error');
            }

        } catch (error) {
            console.error('Create Order API Error:', error);
            showToast('Network error: Could not create order. Check server connection.', 'error');
        }
    }
    
    // --- 2. Order Search Logic (Fetches latest status) ---
    async function searchOrder(orderIdFromUrl = null) {
        const orderIdStr = orderIdFromUrl || document.getElementById('search-order-id').value.trim();
        const orderId = parseInt(orderIdStr);

        if (isNaN(orderId) || orderId <= 0) {
            if (!orderIdFromUrl) {
                showToast('Please enter a valid Order ID.', 'error');
                document.getElementById('order-details-container').innerHTML = `<p class="text-center text-muted m-0">Please enter a valid Order ID to search.</p>`;
            }
            return;
        }
        
        showToast(`Searching for Order ID: ${orderId}...`, 'info');
        
        try {
            const token = localStorage.getItem('authToken');
            // This API call will fetch the UPDATED status (SHIPPED/DELIVERED) after payment
            const response = await fetch(`${BACKEND_URL}/order-details/${orderId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            const result = await response.json();

            // Note: Assuming backend sends { "orderId": 123, "status": "SHIPPED", ... }
            const orderData = result.data || result; 

            if (response.ok && orderData.orderId) { 
                showToast(`Order ID ${orderId} found. Status: ${orderData.status}`, 'success');
                renderOrderDetails(orderData);
            } else {
                const errorMessage = result.error || `Order ID ${orderId} not found.`;
                showToast(errorMessage, 'error');
                document.getElementById('order-details-container').innerHTML = `<div class="alert alert-warning text-center">Order not found or access denied for ID: ${orderId}</div>`;
            }
        } catch (error) {
            console.error('Search Order API Error:', error);
            showToast('Network error: Could not connect to the server.', 'error');
        }
    }
    
    // --- 3. Payment Redirection Logic ---
    window.proceedToPayment = function(orderId) {
        if (!orderId) {
            showToast('Order ID not available for payment.', 'error');
            return;
        }
        showToast(`Redirecting to payment for Order ID ${orderId}...`, 'info');
        
        // This links to the payment page, carrying the Order ID
        const paymentUrl = `payment.html?orderId=${orderId}`;
        window.location.href = paymentUrl;
    };


    // --- Rendering Logic ---
    function renderOrderDetails(orderData) {
        const container = document.getElementById('order-details-container');
        
        const formattedDate = new Date(orderData.orderDate).toLocaleString();
        const statusClass = (orderData.status || 'UNKNOWN').toUpperCase();
        
        let actionButton = '';
        if (statusClass === 'PENDING') {
            actionButton = `
                <button class="btn btn-warning fw-bold mt-3" onclick="proceedToPayment(${orderData.orderId})">
                    <i class="fas fa-credit-card me-2"></i> Proceed to Payment
                </button>
            `;
        } else if (statusClass === 'SHIPPED') {
             actionButton = `<p class="text-info small mt-3 fw-bold"><i class="fas fa-shipping-fast me-1"></i> Your order has been shipped! Tracking details soon.</p>`;
        } else if (statusClass === 'DELIVERED') {
             actionButton = `<p class="text-success small mt-3 fw-bold"><i class="fas fa-box-open me-1"></i> Order successfully delivered.</p>`;
        } else {
            actionButton = `<p class="text-muted small mt-3">No further action available for status: ${orderData.status}</p>`;
        }


        const html = `
            <div class="order-detail-card p-3 border rounded">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">Order ID: <span class="text-primary">${orderData.orderId}</span></h4>
                    <span class="order-status ${statusClass} fs-5">${orderData.status}</span>
                </div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between">
                        <span class="fw-semibold">Total Amount:</span>
                        <span class="fw-bold fs-4 text-success">$${(orderData.totalAmount || 0).toFixed(2)}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Order Date:</span>
                        <span>${formattedDate}</span>
                    </li>
                </ul>
                ${actionButton}
            </div>
        `;

        container.innerHTML = html;
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const orderIdInUrl = urlParams.get('orderId');

        if (orderIdInUrl) {
            searchOrder(orderIdInUrl);
            localStorage.removeItem('cartGrandTotal');
        } 
        else if (localStorage.getItem('cartGrandTotal')) {
            createOrderFromCart();
        } 
        else {
            document.getElementById('order-details-container').innerHTML = `<div class="alert alert-info text-center m-0">Welcome! Please search for an existing order by ID.</div>`;
        }
    });
</script>
</body>
</html>